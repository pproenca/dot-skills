---
title: Test Enum Transitions and Scopes
impact: MEDIUM
impactDescription: enums generate methods and scopes that need verification
tags: model, enums, state-transitions, scopes, activerecord
---

## Test Enum Transitions and Scopes

Rails enums auto-generate scopes, bang methods, and predicate methods, but they do not enforce valid transitions between states. Skipping enum tests means you discover missing transition guards, incorrect integer mappings, and scope collisions in production. Test that enum values map correctly, generated scopes return the right records, and your domain enforces valid state transitions.

**Incorrect (skipping enum tests because "Rails generates them automatically"):**

```ruby
RSpec.describe Order, type: :model do
  # "Enums are generated by Rails, no need to test"

  describe "#fulfill" do
    it "fulfills the order" do
      order = create(:order)

      order.fulfill!

      expect(order).to be_fulfilled
    end
  end
end
```

**Correct (testing enum values, scopes, and transition boundaries):**

```ruby
RSpec.describe Order, type: :model do
  describe "status enum" do
    it "defines the expected statuses" do
      expect(described_class.statuses).to eq(
        "pending" => 0,
        "confirmed" => 1,
        "shipped" => 2,
        "delivered" => 3,
        "cancelled" => 4
      )
    end
  end

  describe "enum scopes" do
    it "filters orders by status" do
      pending_order = create(:order, status: :pending)
      shipped_order = create(:order, status: :shipped)
      cancelled_order = create(:order, status: :cancelled)

      expect(Order.pending).to contain_exactly(pending_order)
      expect(Order.shipped).to contain_exactly(shipped_order)
      expect(Order.cancelled).to contain_exactly(cancelled_order)
    end
  end

  describe "status transitions" do
    context "when order is pending" do
      it "can be confirmed" do
        order = create(:order, status: :pending)

        order.confirm!

        expect(order.reload).to be_confirmed
      end

      it "can be cancelled" do
        order = create(:order, status: :pending)

        order.cancel!

        expect(order.reload).to be_cancelled
      end
    end

    context "when order is shipped" do
      it "cannot be cancelled" do
        order = create(:order, status: :shipped)

        expect { order.cancel! }.to raise_error(
          Order::InvalidTransitionError,
          "Cannot cancel a shipped order"
        )
      end

      it "can be marked as delivered" do
        order = create(:order, status: :shipped)

        order.deliver!

        expect(order.reload).to be_delivered
      end
    end

    context "with invalid status values" do
      it "raises an ArgumentError for unknown statuses" do
        expect { Order.new(status: :nonexistent) }.to raise_error(ArgumentError)
      end
    end
  end
end
```

**When NOT to use this pattern:**
- Simple enums with no transition logic (e.g., a category field with no business rules around changes)

Reference: [Active Record Enums â€” Rails API](https://api.rubyonrails.org/classes/ActiveRecord/Enum.html)
